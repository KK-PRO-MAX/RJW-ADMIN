import{W as v,r as g,m as n}from"./index-B_Ky5Mco.js";import{a as _}from"./index-B9ygI19o.js";const i=_.create({baseURL:"https://guiz.haomengwl.com/api",timeout:1e4,headers:{"Content-Type":"application/json"}});i.interceptors.request.use(e=>{var l;const s=localStorage.getItem("token");return s&&(e.headers.token=s),console.log("Group API 发送请求:",(l=e.method)==null?void 0:l.toUpperCase(),e.url),console.log("请求数据:",e.data),e},e=>(console.error("请求拦截器错误:",e),Promise.reject(e)));i.interceptors.response.use(e=>(console.log("Group API 收到响应:",e.status,e.data),e.data&&typeof e.data=="object"&&(e.data.ret!==void 0&&console.log("  ✓ ret:",e.data.ret),e.data.code!==void 0&&console.log("  ✓ code:",e.data.code),e.data.msg!==void 0&&console.log("  ✓ msg:",e.data.msg),e.data.ret_data!==void 0&&(console.log("  ✓ ret_data 类型:",Array.isArray(e.data.ret_data)?"Array":typeof e.data.ret_data),Array.isArray(e.data.ret_data)&&console.log("    数据数量:",e.data.ret_data.length))),e),e=>(console.error("Group API 响应错误:",e.message||e),e.response?(console.error("  HTTP 状态码:",e.response.status),console.error("  响应数据:",e.response.data)):e.request?console.error("  没有接收到响应"):console.error("  请求错误:",e.message),Promise.reject(e)));function w(){return i.post("/Group/group_list")}function h(e){return i.post("/Group/add_group",e)}function A(e){return i.post("/Group/edit_group",e)}function k(e){return i.post("/Group/del_group",e)}const I=v("department",()=>{const e=g([]),s=g(!1),l=g(null),d=async()=>{s.value=!0,l.value=null;try{console.log("开始加载部门列表...");const a=await w();if(console.log("API 响应:",a),a&&a.data){const o=a.data;if(console.log("响应数据结构:",o),o.ret===0||o.code===200||o.code==="200"){let r=o.ret_data;if(typeof r=="string")try{r=JSON.parse(r)}catch(t){throw console.error("解析部门数据失败:",t),new Error("数据格式错误")}return r&&Array.isArray(r)?(e.value=r.map(t=>({id:t.id,name:t.group_name,locker:t.locker_name,assignedBays:t.bay_list,devices:t.bay_total.toString(),category:"A1",user_list:t.user_list,detail:t.detail,expanded:!1})),console.log("✓ 部门列表加载成功，共",e.value.length,"条记录"),e.value):(console.warn("⚠ API 返回格式异常，使用本地演示数据"),e.value=u(),e.value)}else throw new Error(o.msg||`API 错误：${o.code}`)}else throw new Error("无效的 API 响应")}catch(a){const o=a instanceof Error?a.message:"获取部门列表失败";return l.value=o,console.error("✗ 部门列表加载失败:",o,a),console.log("✓ 使用本地演示数据"),e.value=u(),a instanceof Error&&(a.message.includes("Network")||a.message.includes("timeout"))&&n.warning("网络连接失败，显示本地数据"),e.value}finally{s.value=!1}},m=async a=>{var o;s.value=!0,l.value=null;try{const r={group_name:a.name,detail:a.detail||"",locker_id:parseInt(a.locker)||0,user_list:a.user_list||"",bay_list:a.assignedBays||""},t=await h(r);if(t.data&&t.data.ret===0)return n.success("部门添加成功"),await d(),t.data.ret_data;throw new Error(((o=t.data)==null?void 0:o.msg)||"添加部门失败")}catch(r){const t=r instanceof Error?r.message:"添加部门失败";throw l.value=t,n.error(t),console.error("添加部门出错:",r),r}finally{s.value=!1}},f=async a=>{var o;s.value=!0,l.value=null;try{const r={id:a.id,group_name:a.name,detail:a.detail||"",locker_id:parseInt(a.locker)||0,user_list:a.user_list||"",bay_list:a.assignedBays||""},t=await A(r);if(t.data&&(t.data.ret===0||t.data.code===200||t.data.code==="200"))return n.success("部门编辑成功"),await d(),t.data.ret_data;throw new Error(((o=t.data)==null?void 0:o.msg)||"编辑部门失败")}catch(r){const t=r instanceof Error?r.message:"编辑部门失败";throw l.value=t,n.error(t),console.error("编辑部门出错:",r),r}finally{s.value=!1}},p=(a,o)=>{a>=0&&a<e.value.length&&(e.value[a]={...e.value[a],...o})},y=async a=>{var o;s.value=!0,l.value=null;try{const r=e.value[a];if(!r)throw new Error("部门不存在");const t={id:r.id},c=await k(t);if(c.data&&(c.data.ret===0||c.data.code===200||c.data.code==="200"))return n.success("部门删除成功"),e.value.splice(a,1),c.data.ret_data;throw new Error(((o=c.data)==null?void 0:o.msg)||"删除部门失败")}catch(r){const t=r instanceof Error?r.message:"删除部门失败";throw l.value=t,n.error(t),console.error("删除部门出错:",r),r}finally{s.value=!1}},u=()=>[{id:1,name:"Engineering",locker:"Locker A",assignedBays:"1, 2, 3, 4, 5",devices:"12",category:"A1",user_list:"1,2,3",detail:"Engineering department",expanded:!1},{id:2,name:"Marketing",locker:"Locker B",assignedBays:"6, 7, 8, 9, 10",devices:"8",category:"A2",user_list:"4,5,6",detail:"Marketing department",expanded:!1},{id:3,name:"Sales",locker:"Locker C",assignedBays:"11, 12, 13, 14, 15",devices:"15",category:"A3",user_list:"7,8,9",detail:"Sales department",expanded:!1}];return{departments:e,loading:s,error:l,loadDepartments:d,addDepartment:m,editDepartment:f,deleteDepartment:y,updateDepartment:p,getLocalDemoData:u}});export{I as u};
