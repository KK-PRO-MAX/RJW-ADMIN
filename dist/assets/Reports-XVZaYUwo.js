import{a as y}from"./index-B9ygI19o.js";import{g as b}from"./user-DZDS1ZP8.js";import{g as _}from"./device-p3qppuv_.js";import{p as k}from"./locker-BJ-e9BM6.js";import{_ as w,a as d,b as r,d as t,y as p,Y as C,g as M,t as c,a1 as S,F as u,l as h,n as D,O as g}from"./index-B_Ky5Mco.js";const m=y.create({baseURL:"https://guiz.haomengwl.com/api",timeout:1e4,headers:{"Content-Type":"application/json"}});m.interceptors.request.use(l=>{var o;const e=localStorage.getItem("token");return e&&(l.headers.token=e),console.log("Report API 发送请求:",(o=l.method)==null?void 0:o.toUpperCase(),l.url),console.log("请求数据:",l.data),l},l=>(console.error("请求拦截器错误:",l),Promise.reject(l)));m.interceptors.response.use(l=>(console.log("Report API 收到响应:",l.status,l.data),l.data&&typeof l.data=="object"&&(l.data.ret!==void 0&&console.log("  ✓ ret:",l.data.ret),l.data.code!==void 0&&console.log("  ✓ code:",l.data.code),l.data.msg!==void 0&&console.log("  ✓ msg:",l.data.msg),l.data.ret_data!==void 0&&(console.log("  ✓ ret_data 类型:",Array.isArray(l.data.ret_data)?"Array":typeof l.data.ret_data),Array.isArray(l.data.ret_data)&&console.log("    数据数量:",l.data.ret_data.length))),l),l=>(console.error("Report API 响应错误:",l.message||l),l.response?(console.error("  HTTP 状态码:",l.response.status),console.error("  响应数据:",l.response.data)):l.request?console.error("  没有接收到响应"):console.error("  请求错误:",l.message),Promise.reject(l)));function E(l={}){return m.post("/Reports/getlist",l)}const R={data(){return{reportData:[],loading:!1,showDatePicker:!1,startDate:null,endDate:null,startDisplayMonth:new Date,endDisplayMonth:new Date,showEventOptions:!1,selectedEvent:"All",eventOptions:["Deactivated","Activated","Opened Bay","Check-In","Check-Out"],showUsersModal:!1,usersList:[],selectedUsers:[],showDevicesModal:!1,devicesList:[],selectedDevices:[],showBaysModal:!1,baysList:[],selectedBays:[]}},computed:{startDateFormatted(){return this.startDate?this.formatDate(this.startDate):""},endDateFormatted(){return this.endDate?this.formatDate(this.endDate):""},startMonthYear(){const l=this.startDisplayMonth.toLocaleString("en-US",{month:"long"}),e=this.startDisplayMonth.getFullYear();return`${l} ${e}`},endMonthYear(){const l=this.endDisplayMonth.toLocaleString("en-US",{month:"long"}),e=this.endDisplayMonth.getFullYear();return`${l} ${e}`},startDays(){return this.generateDays(this.startDisplayMonth)},endDays(){return this.generateDays(this.endDisplayMonth)}},async mounted(){document.addEventListener("click",l=>{const e=this.$el.querySelector(".event-selector");!e||e.contains(l.target)||(this.showEventOptions=!1)}),await this.loadDropdownData(),this.loadReportData()},methods:{async loadDropdownData(){try{const l=await b();l&&l.data&&l.data.ret===0&&(this.usersList=l.data.ret_data.map(i=>({id:i.id,name:`${i.user_first_name} ${i.user_last_name}`,badgeId:i.user_badge_id})));const e=await _();e&&e.data&&e.data.ret===0&&(this.devicesList=e.data.ret_data.map(i=>({id:i.id,name:i.device_name,deviceId:i.device_id})));const o=await k();if(o&&o.data&&o.data.ret===0){const i=[];o.data.ret_data.forEach(a=>{for(let n=1;n<=a.bay_total;n++)i.push(n)}),this.baysList=[...new Set(i)].sort((a,n)=>a-n)}}catch(l){console.error("加载下拉列表数据失败:",l)}},async loadReportData(){this.loading=!0;try{const l={};if(this.selectedUsers.length>0){const o=this.selectedUsers[0].id;o&&(l.user_id=o)}if(this.selectedDevices.length>0&&(l.devices_id=this.selectedDevices[0].deviceId),this.selectedBays.length>0){const o=this.selectedBays[0];o&&(l.cabinet_no=o)}if(this.selectedEvent!=="All"){const o={Deactivated:"0",Activated:"1","Opened Bay":"2","Check-In":"3","Check-Out":"4"};l.event=o[this.selectedEvent]||this.selectedEvent}if(this.startDate&&(l.start_time=Math.floor(this.startDate.getTime()/1e3)),this.endDate){const o=new Date(this.endDate);o.setHours(23,59,59,999),l.end_time=Math.floor(o.getTime()/1e3)}l.page=1,console.log("请求参数:",l);const e=await E(l);if(console.log("API 响应:",e),e&&e.data){const o=e.data;if(console.log("响应数据结构:",o),o.ret===0||o.code===200||o.code==="200"){let i=o.ret_data;if(typeof i=="string")try{i=JSON.parse(i)}catch(a){throw console.error("解析报告数据失败:",a),new Error("数据格式错误")}i&&Array.isArray(i)?(this.reportData=i,console.log("✓ 报告数据加载成功，共",this.reportData.length,"条记录")):(console.warn("⚠ API 返回格式异常，使用空数据"),this.reportData=[])}else throw new Error(o.msg||`API 错误：${o.code}`)}else throw new Error("无效的 API 响应")}catch(l){console.error("✗ 报告数据加载失败:",l),this.reportData=[]}finally{this.loading=!1}},toggleSelection(l,e){const o=l.findIndex(i=>typeof i=="object"?i.id===e.id:i===e);o>-1?l.splice(o,1):l.push(e)},formatDateTime(l,e){return!l||!e?"":`${l} - ${e}`},clearFilters(){this.selectedUsers=[],this.selectedDevices=[],this.selectedBays=[],this.selectedEvent="All",this.startDate=null,this.endDate=null,this.loadReportData()},generateDays(l){const e=l.getFullYear(),o=l.getMonth(),i=new Date(e,o+1,0).getDate(),a=new Date(e,o,1).getDay(),n=[];for(let s=0;s<a;s++)n.push({date:null});for(let s=1;s<=i;s++)n.push({date:new Date(e,o,s)});return n},formatDate(l){const e=l.getMonth()+1,o=l.getDate(),i=l.getFullYear();return`${e.toString().padStart(2,"0")}/${o.toString().padStart(2,"0")}/${i}`},isSameDate(l,e){return!l||!e?!1:l.getFullYear()===e.getFullYear()&&l.getMonth()===e.getMonth()&&l.getDate()===e.getDate()},isDateInRange(l){return!this.startDate||!this.endDate?!1:l>=this.startDate&&l<=this.endDate},selectStartDate(l){this.startDate=new Date(l),this.endDate&&this.endDate<this.startDate&&(this.endDate=null)},selectEndDate(l){this.endDate=new Date(l)},prevMonth(l){l==="start"?this.startDisplayMonth=new Date(this.startDisplayMonth.getFullYear(),this.startDisplayMonth.getMonth()-1,1):this.endDisplayMonth=new Date(this.endDisplayMonth.getFullYear(),this.endDisplayMonth.getMonth()-1,1)},nextMonth(l){l==="start"?this.startDisplayMonth=new Date(this.startDisplayMonth.getFullYear(),this.startDisplayMonth.getMonth()+1,1):this.endDisplayMonth=new Date(this.endDisplayMonth.getFullYear(),this.endDisplayMonth.getMonth()+1,1)},resetDates(){this.startDate=null,this.endDate=null},confirmDates(){this.showDatePicker=!1,this.loadReportData()},toggleEventOptions(){this.showEventOptions=!this.showEventOptions},selectEvent(l){this.selectedEvent=l,this.showEventOptions=!1,this.loadReportData()},exportTableData(){let l=`Time,User,User Role,Device,Bay #,Event
`;this.reportData.forEach(s=>{const v=[this.escapeCsvField(this.formatDateTime(s.date_str,s.time_str)),this.escapeCsvField(s.user_name),this.escapeCsvField(s.user_role),this.escapeCsvField(s.devices_id.toString()),this.escapeCsvField(s.cabinet_no.toString()),this.escapeCsvField(s.event_name)];l+=v.join(",")+`
`});const e=new Blob([l],{type:"text/csv;charset=utf-8;"}),o=URL.createObjectURL(e),i=document.createElement("a");i.setAttribute("href",o);const n=new Date().toISOString().split("T")[0];i.setAttribute("download",`report_data_${n}.csv`),document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(o)},escapeCsvField(l){return l?l.includes(",")||l.includes('"')||l.includes(`
`)||l.includes("\r")?`"${l.replace(/"/g,'""')}"`:l:""}}},U={class:"report-page"},F={class:"filter-section"},A={class:"filter-row first-row"},B={class:"filter-item"},L=["value"],T={class:"filter-item"},x=["value"],I={class:"filter-item"},O=["value"],P={class:"filter-row second-row"},Y={class:"filter-item"},j={class:"event-selector"},N={class:"select-options"},V=["onClick"],q={class:"filter-item date-filter"},z=["value"],H=["value"],W={key:0,class:"date-picker-popup"},J={class:"date-picker-header"},G={class:"date-picker-body"},K={class:"calendar"},Q={class:"calendar-header"},X={class:"days"},Z=["onClick"],$={class:"calendar"},ee={class:"calendar-header"},te={class:"days"},se=["onClick"],le={class:"date-picker-footer"},ae={class:"filter-actions"},ne={ref:"reportTable",class:"report-table desktop-table"},oe={class:"report-cards mobile-cards"},ie={class:"card-row data-row"},de={class:"card-cell"},re={class:"cell-value"},ce={class:"card-cell"},ve={class:"cell-value"},ue={class:"card-cell"},he={class:"cell-value"},De={class:"card-row data-row"},pe={class:"card-cell"},me={class:"cell-value"},ge={class:"card-cell"},fe={class:"cell-value"},ye={class:"card-cell"},be={class:"cell-value"},_e={key:0,class:"modal-overlay"},ke={class:"modal"},we={class:"modal-header"},Ce={class:"modal-body grid-container"},Me=["onClick"],Se={class:"modal-footer"},Ee={key:1,class:"modal-overlay"},Re={class:"modal"},Ue={class:"modal-header"},Fe={class:"modal-body grid-container"},Ae=["onClick"],Be={class:"modal-footer"},Le={key:2,class:"modal-overlay"},Te={class:"modal"},xe={class:"modal-header"},Ie={class:"modal-body grid-container"},Oe=["onClick"],Pe={class:"modal-footer"};function Ye(l,e,o,i,a,n){return r(),d("div",U,[e[45]||(e[45]=t("h1",null,"Reports",-1)),t("div",F,[t("div",A,[t("div",B,[e[25]||(e[25]=t("label",null,"Users",-1)),t("input",{type:"text",value:a.selectedUsers.length>0?a.selectedUsers.map(s=>s.name).join(", "):"All",readonly:"",class:"clickable-input",onClick:e[0]||(e[0]=s=>a.showUsersModal=!0)},null,8,L)]),t("div",T,[e[26]||(e[26]=t("label",null,"Device",-1)),t("input",{type:"text",value:a.selectedDevices.length>0?a.selectedDevices.map(s=>s.name).join(", "):"All",readonly:"",class:"clickable-input",onClick:e[1]||(e[1]=s=>a.showDevicesModal=!0)},null,8,x)]),t("div",I,[e[27]||(e[27]=t("label",null,"Bay #",-1)),t("input",{type:"text",value:a.selectedBays.length>0?a.selectedBays.join(", "):"All",readonly:"",class:"clickable-input",onClick:e[2]||(e[2]=s=>a.showBaysModal=!0)},null,8,O)])]),t("div",P,[t("div",Y,[e[29]||(e[29]=t("label",null,"Event",-1)),t("div",j,[t("div",{class:"select-trigger",onClick:e[3]||(e[3]=(...s)=>n.toggleEventOptions&&n.toggleEventOptions(...s))},[M(c(a.selectedEvent)+" ",1),e[28]||(e[28]=t("i",{class:"dropdown-icon"},"▼",-1))]),C(t("div",N,[(r(!0),d(u,null,h(a.eventOptions,s=>(r(),d("div",{key:s,class:"option",onClick:v=>n.selectEvent(s)},c(s),9,V))),128))],512),[[S,a.showEventOptions]])])]),t("div",q,[e[33]||(e[33]=t("label",null,"Dates",-1)),t("input",{type:"text",value:n.startDateFormatted,placeholder:"Starting Date",readonly:"",class:"clickable-input",onClick:e[4]||(e[4]=s=>a.showDatePicker=!0)},null,8,z),e[34]||(e[34]=t("span",null,"to",-1)),t("input",{type:"text",value:n.endDateFormatted,placeholder:"Ending Date",readonly:"",class:"clickable-input",onClick:e[5]||(e[5]=s=>a.showDatePicker=!0)},null,8,H),a.showDatePicker?(r(),d("div",W,[t("div",J,[t("button",{onClick:e[6]||(e[6]=s=>a.showDatePicker=!1)},"×"),e[30]||(e[30]=t("h3",null,"Select Date Range",-1))]),t("div",G,[t("div",K,[t("div",Q,[t("button",{onClick:e[7]||(e[7]=s=>n.prevMonth("start"))},"←"),t("h4",null,c(n.startMonthYear),1),t("button",{onClick:e[8]||(e[8]=s=>n.nextMonth("start"))},"→")]),e[31]||(e[31]=t("div",{class:"weekdays"},[t("div",null,"Sun"),t("div",null,"Mon"),t("div",null,"Tue"),t("div",null,"Wed"),t("div",null,"Thu"),t("div",null,"Fri"),t("div",null,"Sat")],-1)),t("div",X,[(r(!0),d(u,null,h(n.startDays,(s,v)=>(r(),d("div",{key:v,class:D(["day",{empty:!s.date,selected:s.date&&n.isSameDate(s.date,a.startDate),"in-range":s.date&&n.isDateInRange(s.date)}]),onClick:f=>s.date&&n.selectStartDate(s.date)},c(s.date?s.date.getDate():""),11,Z))),128))])]),t("div",$,[t("div",ee,[t("button",{onClick:e[9]||(e[9]=s=>n.prevMonth("end"))},"←"),t("h4",null,c(n.endMonthYear),1),t("button",{onClick:e[10]||(e[10]=s=>n.nextMonth("end"))},"→")]),e[32]||(e[32]=t("div",{class:"weekdays"},[t("div",null,"Sun"),t("div",null,"Mon"),t("div",null,"Tue"),t("div",null,"Wed"),t("div",null,"Thu"),t("div",null,"Fri"),t("div",null,"Sat")],-1)),t("div",te,[(r(!0),d(u,null,h(n.endDays,(s,v)=>(r(),d("div",{key:v,class:D(["day",{empty:!s.date,selected:s.date&&n.isSameDate(s.date,a.endDate),"in-range":s.date&&n.isDateInRange(s.date),disabled:s.date&&s.date<a.startDate}]),onClick:f=>s.date&&s.date>=a.startDate&&n.selectEndDate(s.date)},c(s.date?s.date.getDate():""),11,se))),128))])])]),t("div",le,[t("button",{onClick:e[11]||(e[11]=(...s)=>n.resetDates&&n.resetDates(...s))},"Reset"),t("button",{onClick:e[12]||(e[12]=(...s)=>n.confirmDates&&n.confirmDates(...s))},"Apply")])])):p("",!0)])]),t("div",ae,[t("button",{class:"btn clear",onClick:e[13]||(e[13]=(...s)=>n.clearFilters&&n.clearFilters(...s))},"Clear Filters"),t("button",{class:"btn run",onClick:e[14]||(e[14]=(...s)=>n.loadReportData&&n.loadReportData(...s))},"Run Report"),t("span",{class:"export-data",onClick:e[15]||(e[15]=(...s)=>n.exportTableData&&n.exportTableData(...s))},"Export Data")])]),t("table",ne,[e[35]||(e[35]=t("thead",null,[t("tr",null,[t("th",null,"Time"),t("th",null,"User"),t("th",null,"User Role"),t("th",null,"Device"),t("th",null,"Bay #"),t("th",null,"Event")])],-1)),t("tbody",null,[(r(!0),d(u,null,h(a.reportData,s=>(r(),d("tr",{key:s.id},[t("td",null,c(n.formatDateTime(s.date_str,s.time_str)),1),t("td",null,c(s.user_name),1),t("td",null,c(s.user_role),1),t("td",null,c(s.devices_id),1),t("td",null,c(s.cabinet_no),1),t("td",null,c(s.event_name),1)]))),128))])],512),t("div",oe,[(r(!0),d(u,null,h(a.reportData,(s,v)=>(r(),d("div",{key:v,class:"report-card"},[e[40]||(e[40]=g('<div class="card-row header-row-card" data-v-5a80bd7c><div class="card-cell" data-v-5a80bd7c><div class="cell-label" data-v-5a80bd7c>Time</div></div><div class="card-divider-vertical" data-v-5a80bd7c></div><div class="card-cell" data-v-5a80bd7c><div class="cell-label" data-v-5a80bd7c>User</div></div><div class="card-divider-vertical" data-v-5a80bd7c></div><div class="card-cell" data-v-5a80bd7c><div class="cell-label" data-v-5a80bd7c>User Role</div></div></div>',1)),t("div",ie,[t("div",de,[t("div",re,c(n.formatDateTime(s.date_str,s.time_str)),1)]),e[36]||(e[36]=t("div",{class:"card-divider-vertical"},null,-1)),t("div",ce,[t("div",ve,c(s.user_name),1)]),e[37]||(e[37]=t("div",{class:"card-divider-vertical"},null,-1)),t("div",ue,[t("div",he,c(s.user_role),1)])]),e[41]||(e[41]=g('<div class="card-row header-row-card" data-v-5a80bd7c><div class="card-cell" data-v-5a80bd7c><div class="cell-label" data-v-5a80bd7c>Device</div></div><div class="card-divider-vertical" data-v-5a80bd7c></div><div class="card-cell" data-v-5a80bd7c><div class="cell-label" data-v-5a80bd7c>Bay #</div></div><div class="card-divider-vertical" data-v-5a80bd7c></div><div class="card-cell" data-v-5a80bd7c><div class="cell-label" data-v-5a80bd7c>Event</div></div></div>',1)),t("div",De,[t("div",pe,[t("div",me,c(s.devices_id),1)]),e[38]||(e[38]=t("div",{class:"card-divider-vertical"},null,-1)),t("div",ge,[t("div",fe,c(s.cabinet_no),1)]),e[39]||(e[39]=t("div",{class:"card-divider-vertical"},null,-1)),t("div",ye,[t("div",be,c(s.event_name),1)])])]))),128))]),a.showUsersModal?(r(),d("div",_e,[t("div",ke,[t("div",we,[e[42]||(e[42]=t("h3",null,"Select Users",-1)),t("button",{class:"close-btn",onClick:e[16]||(e[16]=s=>a.showUsersModal=!1)},"×")]),t("div",Ce,[(r(!0),d(u,null,h(a.usersList,s=>(r(),d("div",{key:s.id,class:D(["grid-item",{selected:a.selectedUsers.some(v=>v.id===s.id)}]),onClick:v=>n.toggleSelection(a.selectedUsers,s)},c(s.name),11,Me))),128))]),t("div",Se,[t("button",{class:"modal-btn cancel",onClick:e[17]||(e[17]=s=>a.showUsersModal=!1)},"Cancel"),t("button",{class:"modal-btn confirm",onClick:e[18]||(e[18]=s=>{a.showUsersModal=!1,n.loadReportData()})},"Confirm")])])])):p("",!0),a.showDevicesModal?(r(),d("div",Ee,[t("div",Re,[t("div",Ue,[e[43]||(e[43]=t("h3",null,"Select Devices",-1)),t("button",{class:"close-btn",onClick:e[19]||(e[19]=s=>a.showDevicesModal=!1)},"×")]),t("div",Fe,[(r(!0),d(u,null,h(a.devicesList,s=>(r(),d("div",{key:s.id,class:D(["grid-item",{selected:a.selectedDevices.some(v=>v.id===s.id)}]),onClick:v=>n.toggleSelection(a.selectedDevices,s)},c(s.name),11,Ae))),128))]),t("div",Be,[t("button",{class:"modal-btn cancel",onClick:e[20]||(e[20]=s=>a.showDevicesModal=!1)},"Cancel"),t("button",{class:"modal-btn confirm",onClick:e[21]||(e[21]=s=>{a.showDevicesModal=!1,n.loadReportData()})},"Confirm")])])])):p("",!0),a.showBaysModal?(r(),d("div",Le,[t("div",Te,[t("div",xe,[e[44]||(e[44]=t("h3",null,"Select Bay Numbers",-1)),t("button",{class:"close-btn",onClick:e[22]||(e[22]=s=>a.showBaysModal=!1)},"×")]),t("div",Ie,[(r(!0),d(u,null,h(a.baysList,s=>(r(),d("div",{key:s,class:D(["grid-item",{selected:a.selectedBays.includes(s)}]),onClick:v=>n.toggleSelection(a.selectedBays,s)},c(s),11,Oe))),128))]),t("div",Pe,[t("button",{class:"modal-btn cancel",onClick:e[23]||(e[23]=s=>a.showBaysModal=!1)},"Cancel"),t("button",{class:"modal-btn confirm",onClick:e[24]||(e[24]=s=>{a.showBaysModal=!1,n.loadReportData()})},"Confirm")])])])):p("",!0)])}const He=w(R,[["render",Ye],["__scopeId","data-v-5a80bd7c"]]);export{He as default};
